{% extends 'partials/base.html.twig' %}

{% block titlebar %}
  <div class="button-bar">
    <a class="button" href="#modal-admin-addon-user-manager-new" data-remodal-target="modal-admin-addon-user-manager-new"><i class="fa fa-plus"></i> {{ "PLUGIN_ADMIN.ADD"|tu }}</a>
  </div>

  <h1><i class="fa fa-fw fa-user-o"></i> Manage Users</h1>
{% endblock %}

{% block content %}
  {% set style = listStyle|default('grid') %}

  <h1>Users</h1>

  <div class="admin-addon-user-manager-style">
    {% if style != 'grid' %}<a href="{{ uri.route(true) ~ '/listStyle' ~ config.system.param_sep ~ 'grid' ~ '/page' ~ config.system.param_sep ~ pagination.current }}/"><i class="fa fa-th"></i></a>{% else %}<i class="fa fa-th"></i>{% endif %}
    {% if style != 'list' %}<a href="{{ uri.route(true) ~ '/listStyle' ~ config.system.param_sep ~ 'list' ~ '/page' ~ config.system.param_sep ~ pagination.current }}"><i class="fa fa-list"></i></a>{% else %}<i class="fa fa-list"></i>{% endif %}
  </div>

  <div class="admin-addon-user-manager admin-addon-user-manager--{{ style }}">
    {% if style == 'list' %}
    <div class="cell cell--header">
      <div class="user">
        <div class="user__username">Username</div>
        <div class="user__email">Email</div>
        <div class="user__actions">Actions</div>
      </div>
    </div>
    {% endif %}
    {% for user in users %}
    <div class="cell">
      <div class="user">
        {% if style == 'grid' %}
        <div class="user__avatar"><a href="{{ base_url }}/user/{{ user.username }}"><img src="{{ user.avatarUrl }}" /></a></div>
        {% endif %}
        <div class="user__username"><a href="{{ base_url }}/user/{{ user.username }}">{{ user.username }}</a></div>
        <div class="user__email">{{ user.email }}</div>
        <div class="user__actions">
          <a href="{{ uri.addNonce(base_url ~ '/user/' ~ user.username ~ '/task' ~ config.system.param_sep ~ 'userDelete', 'admin-form', 'admin-nonce') }}" class="delete">Delete</a>
        </div>
      </div>
    </div>
    {% endfor %}
  </div>

  <div class="admin-addon-user-manager-pagination">
    <ul class="admin-addon-user-manager-pagination__pages">
      {% if pagination.current > 1 %}
      <li><a href="{{ uri.route(true) ~ '/listStyle' ~ config.system.param_sep ~ listStyle ~ '/page' ~ config.system.param_sep ~ '1' }}"><<</a></li>
      {% endif %}
      {% if pagination.current > 2 %}
      <li><a href="{{ uri.route(true) ~ '/listStyle' ~ config.system.param_sep ~ listStyle ~ '/page' ~ config.system.param_sep ~ (pagination.current - 1) }}"><</a></li>
      {% endif %}
      {% set fromPage = (pagination.current - 2 < 1) ? 1 : pagination.current - 2 %}
      {% set toPage = (pagination.current + 2 > pagination.count) ? pagination.count : pagination.current + 2 %}
      {% for i in fromPage..toPage %}
        {% if pagination.current == i %}
          <li class="current">{{ i }}</li>
        {% else %}
          <li><a href="{{ uri.route(true) ~ '/listStyle' ~ config.system.param_sep ~ listStyle ~ '/page' ~ config.system.param_sep ~ i }}">{{ i }}</a></li>
        {% endif %}
      {% endfor %}
      {% if pagination.current < pagination.count - 1 %}
      <li><a href="{{ uri.route(true) ~ '/listStyle' ~ config.system.param_sep ~ listStyle ~ '/page' ~ config.system.param_sep ~ (pagination.current + 1) }}">></a></li>
      {% endif %}
      {% if pagination.current < pagination.count %}
      <li><a href="{{ uri.route(true) ~ '/listStyle' ~ config.system.param_sep ~ listStyle ~ '/page' ~ config.system.param_sep ~ pagination.count }}">>></a></li>
      {% endif %}
    </ul>
    {% set startOffset = pagination.startOffset + 1 %}
    {% set endOffset = pagination.endOffset %}
    <div class="admin-addon-user-manager-pagination__text">Showing {{ startOffset }} - {{ endOffset }} of {{ pagination.total }}</div>
  </div>

  <div class="remodal" data-remodal-id="modal-admin-addon-user-manager-new" data-remodal-options="hashTracking: false">
    <form method="post" onsubmit='handleAdminAddonUserManagerSubmit(this); return false;'>
      {% for field in fields %}
        {% if field.type %}
          {% set value = data.value(field.name) %}
          <div class="block block-{{field.type}}">
            {% include ["forms/fields/#{field.type}/#{field.type}.html.twig", 'forms/fields/text/text.html.twig'] %}
          </div>
        {% endif %}
      {% endfor %}

      <div class="button-bar">
        <button class="button primary" >{{ "PLUGIN_ADMIN.CONTINUE"|tu }}</button>
      </div>
    </form>
  </div>

  <script>
    function handleAdminAddonUserManagerSubmit(form) {
      var username = form.querySelector('[name=username]').value;
      window.location = '{{ base_url }}/user/' + username;
    }
  </script>
{% endblock %}
